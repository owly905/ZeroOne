if (!hasInterface) exitWith {}; private["_oldValTemp","_oldVal","_filter","_count","_amount","_canProcessAmountTemp","_canProcessAmount","_ProcessAmounts","_val","_tempVal","_oldItems","_newItems","_cost","_upp","_time"]; private _inventoryContent = []; private _vendor = cursorObject; private _type = param[0,"",[""]]; private _isHideout = param[1,false,[false]]; private _exit = false; if (_isHideout) then { _exit = call zero_fnc_checkHideout; }; if(isNull _vendor || _type isEqualTo "" || (player distance _vendor > 10) || _exit) exitWith {}; if(!isNull (objectParent player)) exitWith {(localize "STR_NOTF_VehicleGetOut") call zero_fnc_msg;}; if(player getVariable["zero_var_restrained",false]) exitWith {localize "STR_General_Zipties_Error"}; if(isClass(missionConfigFile >> "zero_CfgProcess" >> _type))then{ _filter = false; _oldItems = getArray(missionConfigFile >> "zero_CfgProcess" >> _type >> "MaterialInput"); _newItems = getArray(missionConfigFile >> "zero_CfgProcess" >> _type >> "MaterialOutput"); _cost = getNumber(missionConfigFile >> "zero_CfgProcess" >> _type >> "noLicenseCost"); _time = getArray(missionConfigFile >> "zero_CfgProcess" >> _type >> "time"); _upp = (localize (getText(missionConfigFile >> "zero_CfgProcess" >> _type >> "Text"))); }else{_filter = true;}; if(_filter) exitWith {diag_log "Processing Error"}; _begin = (_time select 0); _end = (_time select 1); if(_begin != -1 && _end != -1) then { _exit = true; if(((zero_var_reallifetime + serverTime) / 3600) > _begin) exitWith {_exit = false;}; if(((zero_var_reallifetime + serverTime) / 3600) > _end) exitWith {_exit = true;}; }; if (_exit) exitWith {"Du kannst zum aktuellen Zeitpunkt hier nicht Verarbeiten!" call zero_fnc_msg;}; { _index = [(_x select 0),zero_var_inventory] call zero_fnc_findIndex; if(_index isEqualTo -1) exitWith {(format["Du hast kein %1 dabei!",getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name")]) call zero_fnc_msg;_exit = true;}; _oldValTemp = (zero_var_inventory select _index) select 1; if(_oldValTemp < (_x select 1)) exitWith {(format["Du hast zu wenig %1 dabei!",getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name")]) call zero_fnc_msg;_exit = true;}; _inventoryContent pushBack [((zero_var_inventory select _index) select 0),((zero_var_inventory select _index) select 1)]; }forEach _oldItems; if(_exit) exitWith {}; private _licenseReq = getText(missionConfigFile >> "zero_CfgProcess" >> _type >> "licenseReq"); private _hasLicense = missionNamespace getVariable (([_licenseReq,0] call zero_fnc_licenseType) select 0); _count = 0; _ProcessAmounts = []; { _amount = (_x select 1); _canProcessAmountTemp = 0; while{(_amount - ((_oldItems select _count) select 1)) >= 0} do{ _amount = _amount - ((_oldItems select _count) select 1); _canProcessAmountTemp = _canProcessAmountTemp + 1; }; _count = _count + 1; _ProcessAmounts pushBack _canProcessAmountTemp; }forEach _inventoryContent; _canProcessAmount = selectMin _ProcessAmounts; if(_canProcessAmount isEqualTo 0) exitWith {diag_log "Processing Error 1";}; _cost = _cost * _canProcessAmount; _count = 0; _val = 0; { _count = _count + 1; _tempVal = [(_x select 0)] call zero_fnc_getSkillValueProcessing; _val = _val + _tempVal; }forEach _newItems; _val = _val/_count; _val = _val / zero_var_buff_farmMultiplier; disableSerialization; 5 cutRsc ["zero_var_progress","PLAIN"]; private _ui = uiNamespace getVariable "zero_var_progress"; private _progress = _ui displayCtrl 38201; private _pgText = _ui displayCtrl 38202; _pgText ctrlSetText format["%2 (1%1)...","%",_upp]; _progress progressSetPosition 0.01; private _cP = 0.01; zero_var_is_processing = true; if(_hasLicense) then { for "_i" from 0 to 100 step 1 do { uiSleep _val; _cP = _cP + 0.01; _progress progressSetPosition _cP; _pgText ctrlSetText format["%3 (%1%2)...",round(_cP * 100),"%",_upp]; if(_cP >= 1) exitWith {}; if(player distance _vendor > 10 || zero_var_istazed || !alive player) exitWith {}; }; 5 cutText ["","PLAIN"]; if(player distance _vendor > 10) exitWith {(localize "STR_Process_Stay") call zero_fnc_msg; zero_var_is_processing = false;}; _count = 0; private _removedItems = []; { _processAmount = (((_oldItems select _count) select 1)*_canProcessAmount); _item = (_x select 0); if(!([false,_item,_processAmount] call zero_fnc_handleZOInv)) exitWith {_exit=true};
_removedItems pushBack [_item,_processAmount]; _count = _count + 1; }forEach _inventoryContent; if(_exit) exitWith { { if(!([true,(_x select 0),(_x select 1)] call zero_fnc_handleZOInv)) exitWith {}; }forEach _removedItems; zero_var_is_processing = false; }; { if(!([true,(_x select 0),((_x select 1) * _canProcessAmount)] call zero_fnc_handleZOInv)) exitWith {_exit=true}; [(_x select 0),((_x select 1) * _canProcessAmount)] call zero_fnc_improveSkillProcessing; }forEach _newItems; if(_exit) exitWith {zero_var_is_processing = false;}; private _toProcessText = ""; { if(_toProcessText == "") then{ _toProcessText = _toProcessText + str((_x select 1)*_canProcessAmount) + " " + getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name"); }else{ _toProcessText = _toProcessText + ", " + str((_x select 1)*_canProcessAmount) + " " + getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name"); }; }forEach _oldItems; private _processedText = ""; { if(_processedText == "") then{ _processedText = _processedText + str((_x select 1)*_canProcessAmount) + " " + getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name"); }else{ _processedText = _processedText + ", " + str((_x select 1)*_canProcessAmount) + " " + getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name"); }; }forEach _newItems; titleText[format[localize "STR_Process_Processed",_toProcessText,_processedText],"PLAIN"]; zero_var_is_processing = false; [format ["ITEM PROCESSED: %1 (%2, %3) hat %4 zu %5 verarbeitet",player getVariable["zero_var_realname",name player], getPlayerUID player, playerSide, _toProcessText, _processedText]] call zero_fnc_zoLog; }else{ if(([3, 0] call zero_fnc_Z0Check) < _cost) exitWith {(format[localize "STR_Process_License",[_cost] call zero_fnc_numberText]) call zero_fnc_msg; 5 cutText ["","PLAIN"]; zero_var_is_processing = false;}; for "_i" from 0 to 100 step 1 do { uiSleep _val; _cP = _cP + 0.01; _progress progressSetPosition _cP; _pgText ctrlSetText format["%3 (%1%2)...",round(_cP * 100),"%",_upp]; if(_cP >= 1) exitWith {}; if(player distance _vendor > 10 || zero_var_istazed || !alive player) exitWith {}; }; 5 cutText ["","PLAIN"]; if(player distance _vendor > 10) exitWith {(localize "STR_Process_Stay") call zero_fnc_msg; zero_var_is_processing = false;}; if(([3, 0] call zero_fnc_Z0Check) < _cost) exitWith {(format[localize "STR_Process_License",[_cost] call zero_fnc_numberText]) call zero_fnc_msg; zero_var_is_processing = false;}; _count = 0; private _removedItems = []; { _processAmount = (((_oldItems select _count) select 1)*_canProcessAmount); _item = (_x select 0); if(!([false,_item,_processAmount] call zero_fnc_handleZOInv)) exitWith {_exit=true}; _removedItems pushBack [_item,_processAmount]; _count = _count + 1; }forEach _inventoryContent; if(_exit) exitWith { { if(!([true,(_x select 0),(_x select 1)] call zero_fnc_handleZOInv)) exitWith {}; }forEach _removedItems; zero_var_is_processing = false; }; { if(!([true,(_x select 0),((_x select 1) * _canProcessAmount)] call zero_fnc_handleZOInv)) exitWith {_exit=true}; [(_x select 0),((_x select 1) * _canProcessAmount)] call zero_fnc_improveSkillProcessing; }forEach _newItems; if(_exit) exitWith {zero_var_is_processing = false;}; private _toProcessText = ""; { if(_toProcessText == "") then{ _toProcessText = _toProcessText + str((_x select 1)*_canProcessAmount) + " " + getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name"); }else{ _toProcessText = _toProcessText + ", " + str((_x select 1)*_canProcessAmount) + " " + getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name"); }; }forEach _oldItems; private _processedText = ""; { if(_processedText == "") then{ _processedText = _processedText + str((_x select 1)*_canProcessAmount) + " " + getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name"); }else{ _processedText = _processedText + ", " + str((_x select 1)*_canProcessAmount) + " " + getText(missionConfigFile >> "zero_CfgItems" >> (_x select 0) >> "name"); }; }forEach _newItems; titleText[format[localize "STR_Process_Processed2",_toProcessText,_processedText,[_cost] call zero_fnc_numberText],"PLAIN"]; [1, ([3, 0] call zero_fnc_Z0Check) - _cost] call zero_fnc_Z0Check; zero_var_is_processing = false; [format ["ITEM PROCESSED: %1 (%2, %3) hat %4 zu %5 fuer %6 verarbeitet",player getVariable["zero_var_realname",name player], getPlayerUID player, playerSide, _toProcessText, _processedText, [_cost] call zero_fnc_numberText]] call zero_fnc_zoLog; };
